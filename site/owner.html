<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Owner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <link rel="stylesheet" href="assets/vendor/simple-datatables/style.css">
  <link rel="stylesheet" href="assets/style.css">
</head>

<body>
  <div class="container">
    <header
      class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 border-bottom">
      <div class="col-md-3 mb-2 mb-md-0">
        <!---png logo-->
                <a href="/" class="d-flex align-items-center col-md-3 mb-2 mb-md-0 text-dark text-decoration-none">
                    <img src="assets/logis.png" alt="logo" height="70" class="rounded-circle flex-shrink-0">
                </a>



      </div>
      <button type="button" class="btn btn-success" onclick="logout()">Logout</button>



    </header>
  </div>



  <main>
    <div class="container">
      <div class="row">
        <div class="col-md-4">
          <ul class="nav nav-pills flex-column mb-auto" id="navList">
            <li class="nav-item">
              <a href="#" class="nav-link a active">Create Listing</a>
            </li>
            <li>
              <a href="#" class="nav-link b">View orders</a>
            </li>
            <li>
              <a href="#" class="nav-link c">View reviews</a>
            </li>
            <li>
              <a href="#" class="nav-link d">Manage listings</a>
            </li>

          </ul>
        </div>

        <div class="col-md-8">

          <div class="container" id="createListingPage">
            <!--create listing form-->

            <div class="h-100 p-5 bg-body-tertiary border rounded-3">
              <form>

                <h1 class="h5 mb-3 fw-normal">Create a new business listing</h1>

                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="businessName" placeholder="Business Name">
                  <label for="businessName">Business Name</label>
                </div>

                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="businessAddress" placeholder="Business Address">
                  <label for="businessAddress">Business Address</label>
                </div>

                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="businessPhone" placeholder="Business Phone Number">
                  <label for="businessPhone">Business Phone Number</label>

                </div>

                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="businessEmail" placeholder="Business Email">
                  <label for="businessEmail">Business Email</label>

                </div>

                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="businessWebsite" placeholder="Business Website">
                  <label for="businessWebsite">Business Website</label>

                </div>

                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="businessDescription" placeholder="Business Description">
                  <label for="businessDescription">Business Description</label>

                </div>

                <div class="container">
                  <div class="row">
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label for="image3" class="form-label">Image 1</label>
                        <input class="form-control form-control-sm" id="image1" type="file">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label for="image2" class="form-label">Image 2</label>
                        <input class="form-control form-control-sm" id="image2" type="file">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label for="image3" class="form-label">Image 3</label>
                        <input class="form-control form-control-sm" id="image3" type="file">
                      </div>
                    </div>
                  </div>
                </div>




                <input class="btn btn-success w-100" type="button" onclick="createListing()"
                  value="Create Listing"></input>
              </form>
            </div>


          </div>
          <div class="container" id="viewReviewsPage" style="display: none;">
            <div class="card">
              <div class="card-body">
                <input class="btn btn-success w-10 float-end" type="button" onclick="viewReviews()" value="Reload"></input>
                <h5 class="card-title">My reviews</h5>



                <!-- Default Table -->
                <table class="table">
                  <thead>
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">Rating</th>
                      <th scope="col">Message</th>


                    </tr>
                  </thead>
                  <tbody id="reviewsTable">

                  </tbody>
                </table>
                <!-- End Default Table Example -->
              </div>
            </div>


          </div>

          <div class="container" id="viewOrdersPage" style="display: none;">
            <div class="card">
              <div class="card-body">
                <input class="btn btn-success w-10 float-end" type="button" onclick="viewOrders()" value="Reload"></input>
                <h5 class="card-title">My messages</h5>



                <!-- Default Table -->
                <table class="table">
                  <thead>
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">Status</th>
                      <th scope="col">Created At</th>
                      <th scope="col">Message</th>


                    </tr>
                  </thead>
                  <tbody id="ordersTable">

                  </tbody>
                </table>
                <!-- End Default Table Example -->
              </div>
            </div>

          </div>

          <div class="container" id="viewListingsPage" style="display: none;">
            <div class="card">
              <div class="card-body">
                <input class="btn btn-success w-10 float-end" type="button" onclick="viewListings()" value="Reload"></input>
                <h5 class="card-title">My listings</h5>



                <!-- Default Table -->
                <table class="table">
                  <thead>
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">Name</th>
                      <th scope="col">Description</th>
                      <th scope="col">Phone</th>
                      <th scope="col">Address</th>
                      <th scope="col">Email</th>
                    </tr>
                  </thead>
                  <tbody id="listingsTable">

                  </tbody>
                </table>
                <!-- End Default Table Example -->
              </div>
            </div>

          </div>

        </div>
      </div>
    </div>


  </main>

    <footer class="footer py-3 my-4">
       
      <p class="text-center text-body-secondary">&copy; 2023 Logis, Inc
</p>
    </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
    crossorigin="anonymous"></script>
  <script src="assets/vendor/simple-datatables/simple-datatables.js"></script>

</body>

</html>


<script>

  url = 'http://localhost:8000/'

  let user = JSON.parse(localStorage.getItem("user"));
  console.log(user);


  // Get the navigation items
  const navItems = document.querySelectorAll("#navList .nav-link");
  const createListingPage = document.getElementById("createListingPage");
  const viewOrdersPage = document.getElementById("viewOrdersPage");
  const viewReviewsPage = document.getElementById("viewReviewsPage");
  const viewListingsPage = document.getElementById("viewListingsPage");

  // Add click event listener to each navigation item
  navItems.forEach((item) => {
    item.addEventListener("click", (event) => {
      // Remove active class from all navigation items
      navItems.forEach((navItem) => {
        navItem.classList.remove("active");
      });

      // Add active class to the clicked navigation item
      event.target.classList.add("active");

      // Hide all containers
      createListingPage.style.display = "none";
      viewOrdersPage.style.display = "none";
      viewReviewsPage.style.display = "none";
      viewListingsPage.style.display = "none";

      // Show the container corresponding to the clicked navigation item
      if (event.target.classList.contains("a")) {
        createListingPage.style.display = "block";
      } else if (event.target.classList.contains("b")) {
        viewOrdersPage.style.display = "block";
      } else if (event.target.classList.contains("c")) {
        viewReviewsPage.style.display = "block";
      } else if (event.target.classList.contains("d")) {
        viewListingsPage.style.display = "block";
      }
    });
  });


  function createListing() {

    // Retrieve input field values
    const businessName = document.getElementById("businessName").value;
    const businessAddress = document.getElementById("businessAddress").value;
    const businessPhone = document.getElementById("businessPhone").value;
    const businessEmail = document.getElementById("businessEmail").value;
    const businessWebsite = document.getElementById("businessWebsite").value;
    const businessDescription = document.getElementById("businessDescription").value;
    const image1 = document.getElementById("image1");
    const image2 = document.getElementById("image2");
    const image3 = document.getElementById("image3");



    const image1name = image1.value.split("\\").pop();
    const image2name = image2.value.split("\\").pop();
    const image3name = image3.value.split("\\").pop();

    // if any of the fields are empty alert the user and exit the function

    if (businessName == "" || businessAddress == "" || businessPhone == "" || businessEmail == "" || businessWebsite == "" || businessDescription == "") {
      alert("Please fill out all fields")
      // exit the function
      return
    }



    // if all three images are not provided alert the user and exit the function
    if (image1name == "" || image2name == "" || image3name == "") {
      alert("Please provide all three images")
      // exit the function
      return

    }

    uploadImage(image1.files[0], image1name)
    uploadImage(image2.files[0], image2name)
    uploadImage(image3.files[0], image3name)

    var requestOptions = {
      method: 'GET',
      redirect: 'follow'
    };



    fetch(url + "uuid?num=" + 4, requestOptions)
      .then(response => response.text())
      .then(result => {
        console.log(result)

        uuids = JSON.parse(result)







        var requestOptions = {
          method: 'GET',
          body: raw,
          redirect: 'follow'
        };


        var myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");

        var raw = JSON.stringify({
          "id": uuids[0],
          "ownerId": user.id,
          "name": businessName,
          "description": businessDescription,
          "phone": businessPhone,
          "address": businessAddress,
          "email": businessEmail,
          "images": [
            {
              "id": uuids[1],
              "url": image1name
            },
            {
              "id": uuids[2],
              "url": image2name
            },
            {
              "id": uuids[3],
              "url": image3name
            }
          ]
        });

        console.log(raw);
        var requestOptions = {
          method: 'POST',
          headers: myHeaders,
          body: raw,
          redirect: 'follow'
        };
        fetch("http://localhost:8000/listings", requestOptions)
          .then(response => response.text())
          .then(result => {
            console.log(result)
            alert("Listing created successfully")
            //reload
            location.reload();
          })
          .catch(error => console.log('error', error));

      })
      .catch(error => console.log('error', error));




    function uploadImage(imageData, imageName) {

      var myHeaders = new Headers();
      myHeaders.append("Image-Name", imageName);
      myHeaders.append("Content-Type", "image/jpeg");

      var file = imageData;

      var requestOptions = {
        method: 'POST',
        headers: myHeaders,
        body: file,
        redirect: 'follow'
      };

      fetch("http://localhost:7000/images", requestOptions)
        .then(response => response.text())
        .then(result => console.log(result))
        .catch(error => console.log('error', error));


    }


  }

  function viewListings() {

    var requestOptions = {
      method: 'GET',
      redirect: 'follow'
    };

    fetch(url + `listings?owner_id=${user.id}`, requestOptions)
      .then(response => response.text())
      .then(result => {
        console.log(result)
        listings = JSON.parse(result)
        console.log(listings)

        var table = document.getElementById("listingsTable");
        table.innerHTML = ""
        listings.forEach((listing, index) => {
          var row = table.insertRow(-1);
          var cell1 = row.insertCell(0);
          var cell2 = row.insertCell(1);
          var cell3 = row.insertCell(2);
          var cell4 = row.insertCell(3);
          var cell5 = row.insertCell(4);
          var cell6 = row.insertCell(5);

          cell1.innerHTML = index + 1;
          cell2.innerHTML = listing.name;
          cell3.innerHTML = listing.description;
          cell4.innerHTML = listing.phone;
          cell5.innerHTML = listing.address;
          cell6.innerHTML = listing.email;







        });

      })
      .catch(error => console.log('error', error));
  }




  function viewOrders() {

    var requestOptions = {
      method: 'GET',
      redirect: 'follow'
    };

    fetch(url + `orders?owner_id=${user.id}`, requestOptions)
      .then(response => response.text())
      .then(result => {
        console.log(result)
        orders = JSON.parse(result)
        console.log(orders)

        var table = document.getElementById("ordersTable");
        table.innerHTML = ""
        orders.forEach((order, index) => {
          var row = table.insertRow(-1);
          var cell1 = row.insertCell(0);
          var cell2 = row.insertCell(1);
          var cell3 = row.insertCell(2);
          var cell4 = row.insertCell(3);

          cell1.innerHTML = index;
          cell2.innerHTML = order.status;
          cell3.innerHTML = order.createdAt;
          cell4.innerHTML = order.message;

        });

      })
      .catch(error => console.log('error', error));
  }

  function viewReviews() {

    var requestOptions = {
      method: 'GET',
      redirect: 'follow'
    };

    fetch(url + `reviews?owner_id=${user.id}`, requestOptions)
      .then(response => response.text())
      .then(result => {
        console.log(result)
        reviews = JSON.parse(result)
        console.log(reviews)

        var table = document.getElementById("reviewsTable");
        table.innerHTML = ""
        reviews.forEach((review, index) => {
          var row = table.insertRow(-1);
          var cell1 = row.insertCell(0);
          var cell2 = row.insertCell(1);
          var cell3 = row.insertCell(2);
          var cell4 = row.insertCell(3);

          cell1.innerHTML = index;
          cell2.innerHTML = review.rating;
          cell3.innerHTML = review.message;


        });

      })
      .catch(error => console.log('error', error));
  }


  viewListings()
  viewOrders()
  viewReviews()

  function logout() {
    localStorage.removeItem("user")
    window.location.href = "index.html"
  }
</script>